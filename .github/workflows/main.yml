name: Deploy MiriX Portfolio files to Server

on:
  push:
    branches:
      - master   # ‚Üê –µ—Å–ª–∏ —É —Ç–µ–±—è main, –ø–æ–º–µ–Ω—è–π –∑–¥–µ—Å—å –∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö repo

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-prod
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build Angular (prod)
        run: npm run build --if-present || ng build --configuration production

      # üëá –£–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å —Å–±–æ—Ä–∫–∏
      # –û–±—ã—á–Ω–æ: dist/<project-name>/browser
      - name: Show dist
        run: ls -la dist && find dist -maxdepth 2 -type d -print

      # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ—á–∏—Å—Ç–∏–º —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
      - name: Clean target dir
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}      # –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –≤ GitHub Secrets
          port: 22
          script: |
            mkdir -p /var/www/html/mirix.uz
            rm -rf /var/www/html/mirix.uz/*

      - name: Upload via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}        # –ò–°–ü–û–õ–¨–ó–£–ï–ú –∫–ª—é—á, –∞ –Ω–µ password
          port: 22
          source: "dist/m1rix.github.io/browser/*"   # ‚Üê –ø—Ä–æ–≤–µ—Ä—å –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞!
          target: "/var/www/html/mirix.uz/"
          overwrite: true
          strip_components: 3
